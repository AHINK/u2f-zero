C51 COMPILER V9.53.0.0   EEPROM                                                            03/28/2016 20:17:25 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE EEPROM
OBJECT MODULE PLACED IN .\src/eeprom.OBJ
COMPILER INVOKED BY: Z:\home\pp\SimplicityStudio_v3\developer\toolchains\keil_8051\9.53\BIN\C51.exe /home/pp/apps/u2f-ze
                    -ro/firmware/src/eeprom.c OMF2 LARGE DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(9,SIZE) INTVECT
                    -OR(0X0000) INTPROMOTE INCDIR(/home/pp/apps/u2f-zero/firmware/inc/config;/home/pp/apps/u2f-zero/firmware/inc;/home/pp/app
                    -s/u2f-zero/firmware/tinyprintf;/home/pp/apps/u2f-zero/firmware/tests;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/
                    -v3//Device/shared/si8051Base;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Device/EFM8UB1;/home/pp/SimplicitySt
                    -udio_v3/developer/sdks/si8051/v3//Device/EFM8UB1/inc;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Lib/efm8_usb
                    -/inc;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Device/EFM8UB1/peripheral_driver/inc;/home/pp/SimplicityStud
                    -io_v3/developer/sdks/si8051/v3//Lib/efm8_assert) REGFILE(u2f-firmware.ORC) PRINT(.\src/eeprom.lst) COND PAGEWIDTH(120) P
                    -AGELENGTH(65) OBJECT(.\src/eeprom.OBJ)

line level    source

   1          /*
   2           * eeprom.c
   3           *
   4           *  Created on: Mar 4, 2016
   5           *      Author: pp
   6           */
   7          #include <SI_EFM8UB1_Register_Enums.h>
   8          #include <stdint.h>
   9          
  10          #include "eeprom.h"
  11          
  12          void eeprom_init()
  13          {
  14   1              uint8_t secbyte;
  15   1              eeprom_read(0xFBFF,&secbyte,1);
  16   1              if (secbyte == 0xff)
  17   1              {
  18   2                      eeprom_erase(0xFBC0);
  19   2                      secbyte = -32;
  20   2                      eeprom_write(0xFBFF, &secbyte, 1);
  21   2              }
  22   1      }
  23          
  24          void eeprom_read(uint16_t addr, uint8_t * buf, uint8_t len)
  25          {
  26   1              uint8_t code * eepaddr =  (uint8_t code *) addr;
  27   1              bit old_int;
  28   1      
  29   1              while(len--)
  30   1              {
  31   2                      old_int = IE_EA;
  32   2                      IE_EA = 0;
  33   2                      *buf++ = *eepaddr++;
  34   2                      IE_EA = old_int;
  35   2              }
  36   1      }
  37          
  38          void _eeprom_write(uint16_t addr, uint8_t * buf, uint8_t len, uint8_t flags)
  39          {
  40   1              uint8_t xdata * data eepaddr = (uint8_t xdata *) addr;
  41   1              bit old_int;
  42   1      
  43   1              while(len--)
  44   1              {
  45   2                      old_int = IE_EA;
  46   2                      IE_EA = 0;
  47   2                      // Enable VDD monitor
  48   2                      VDM0CN = 0x80;
C51 COMPILER V9.53.0.0   EEPROM                                                            03/28/2016 20:17:25 PAGE 2   

  49   2                      RSTSRC = 0x02;
  50   2      
  51   2                      // unlock key
  52   2                      FLKEY  = 0xA5;
  53   2                      FLKEY  = 0xF1;
  54   2                      PSCTL |= flags;
  55   2      
  56   2                      *eepaddr = *buf;
  57   2                      PSCTL &= ~flags;
  58   2                      IE_EA = old_int;
  59   2      
  60   2                      eepaddr++;
  61   2                      buf++;
  62   2              }
  63   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    206    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
