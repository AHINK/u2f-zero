C51 COMPILER V9.53.0.0   MAIN                                                              03/29/2016 00:06:39 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\src/main.OBJ
COMPILER INVOKED BY: Z:\home\pp\SimplicityStudio_v3\developer\toolchains\keil_8051\9.53\BIN\C51.exe /home/pp/apps/u2f-ze
                    -ro/firmware/src/main.c OMF2 LARGE DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(9,SIZE) INTVECTOR
                    -(0X0000) INTPROMOTE INCDIR(/home/pp/apps/u2f-zero/firmware/inc/config;/home/pp/apps/u2f-zero/firmware/inc;/home/pp/apps/
                    -u2f-zero/firmware/tests;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Device/shared/si8051Base;/home/pp/Simplic
                    -ityStudio_v3/developer/sdks/si8051/v3//Device/EFM8UB1;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Device/EFM8
                    -UB1/inc;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Lib/efm8_usb/inc;/home/pp/SimplicityStudio_v3/developer/s
                    -dks/si8051/v3//Device/EFM8UB1/peripheral_driver/inc;/home/pp/SimplicityStudio_v3/developer/sdks/si8051/v3//Lib/efm8_asse
                    -rt) REGFILE(u2f-firmware.ORC) PRINT(.\src/main.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src/main.OBJ)

line level    source

   1          #include <SI_EFM8UB1_Register_Enums.h>
   2          #include <stdarg.h>
   3          
   4          #include "efm8_usb.h"
   5          #include "usb_0.h"
   6          #include "atecc508a.h"
   7          #include "InitDevice.h"
   8          #include "descriptors.h"
   9          #include "eeprom.h"
  10          #include "idle.h"
  11          #include "bsp.h"
  12          #include "app.h"
  13          #include "i2c.h"
  14          #include "u2f_hid.h"
  15          #include "u2f.h"
  16          #include "tests.h"
  17          
  18          data struct APP_DATA appdata;
  19          
  20          static void init(struct APP_DATA* ap)
  21          {
  22   1              memset(ap,0, sizeof(struct APP_DATA));
  23   1              u2f_hid_init();
  24   1              smb_init();
  25   1              atecc_idle();
  26   1      #ifndef ATECC_SETUP_DEVICE
  27   1              eeprom_init();
  28   1              u2f_init();
  29   1      #endif
  30   1              U2F_BUTTON_VAL = 1;
  31   1      }
  32          
  33          void set_app_error(APP_ERROR_CODE ec)
  34          {
  35   1              appdata.error = ec;
  36   1      }
  37          
  38          void set_app_u2f_hid_msg(struct u2f_hid_msg * msg )
  39          {
  40   1              appdata.state = APP_HID_MSG;
  41   1              appdata.hid_msg = msg;
  42   1      }
  43          
  44          
  45          void rgb(uint8_t r, uint8_t g, uint8_t b)
  46          {
  47   1              LED_B(b);
  48   1              LED_G(g);
  49   1              LED_R(r);
C51 COMPILER V9.53.0.0   MAIN                                                              03/29/2016 00:06:39 PAGE 2   

  50   1      }
  51          
  52          
  53          #define ms_since(ms,num) (((uint16_t)get_ms() - (ms)) >= num ? (1|(ms=(uint16_t)get_ms())):0)
  54          
  55          
  56          
  57          int16_t main(void) {
  58   1      
  59   1              uint16_t ms_heart;
  60   1              uint16_t ms_wink;
  61   1              uint16_t ms_grad;
  62   1              uint8_t winks = 0;
  63   1              uint8_t grad_dir = 0;
  64   1              uint8_t light = 0;
  65   1      
  66   1              enter_DefaultMode_from_RESET();
  67   1              init(&appdata);
  68   1      
  69   1              // STDIO library requires TI to print
  70   1              SCON0_TI = 1;
  71   1      
  72   1              // Enable interrupts
  73   1              IE_EA = 1;
  74   1      
  75   1              u2f_prints("U2F ZERO\r\n");
  76   1      
  77   1              run_tests();
  78   1              atecc_setup_init(appdata.tmp);
  79   1      
  80   1      
  81   1              while (1) {
  82   2      
  83   2                      if (ms_since(ms_heart,500))
  84   2                      {
  85   3                              u2f_printl("ms ", 1, get_ms());
  86   3                      }
  87   2      
  88   2      
  89   2                      if (!USBD_EpIsBusy(EP1OUT) && !USBD_EpIsBusy(EP1IN) && appdata.state != APP_HID_MSG)
  90   2                      {
  91   3                              USBD_Read(EP1OUT, hidmsgbuf, sizeof(hidmsgbuf), true);
  92   3                      }
  93   2      
  94   2                      switch(appdata.state)
  95   2                      {
  96   3                              case APP_NOTHING:
  97   3                                      if (ms_since(ms_grad, 10))
  98   3                                      {
  99   4                                              if (light == 90)
 100   4                                              {
 101   5                                                      grad_dir = 0;
 102   5                                              }
 103   4                                              else if (light == 0)
 104   4                                              {
 105   5                                                      grad_dir = 1;
 106   5                                              }
 107   4                                              if (grad_dir)
 108   4                                                      if (U2F_BUTTON_IS_PRESSED())
 109   4                                                              rgb(0,0,light++);
 110   4                                                      else
 111   4                                                              rgb(0,light++,0);
 112   4                                              else
C51 COMPILER V9.53.0.0   MAIN                                                              03/29/2016 00:06:39 PAGE 3   

 113   4                                                      if (U2F_BUTTON_IS_PRESSED())
 114   4                                                              rgb(0,0,light--);
 115   4                                                      else
 116   4                                                              rgb(0,light--,0);
 117   4                                      }
 118   3                                      break;
 119   3                              case APP_HID_MSG:
 120   3      #ifndef ATECC_SETUP_DEVICE
 121   3                                      u2f_hid_request(appdata.hid_msg);
 122   3      #else
                                              atecc_setup_device((struct config_msg*)appdata.hid_msg);
              #endif
 125   3                                      if (appdata.state == APP_HID_MSG)
 126   3                                              appdata.state = APP_NOTHING;
 127   3                                      break;
 128   3                              case APP_WINK:
 129   3                                      rgb(0,0,150);
 130   3                                      light = 150;
 131   3                                      ms_wink = get_ms();
 132   3                                      appdata.state = _APP_WINK;
 133   3                                      break;
 134   3                              case _APP_WINK:
 135   3      
 136   3                                      if (ms_since(ms_wink,150))
 137   3                                      {
 138   4                                              rgb(0,0,light);
 139   4                                              light = light == 0 ? 150 : 0;
 140   4                                              winks++;
 141   4                                      }
 142   3                                      if (winks == 5)
 143   3                                      {
 144   4                                              winks = 0;
 145   4                                              appdata.state = APP_NOTHING;
 146   4                                      }
 147   3                                      break;
 148   3                      }
 149   2      
 150   2                      if (appdata.error)
 151   2                      {
 152   3                              u2f_printb("error: ", 1, appdata.error);
 153   3                              appdata.error = 0;
 154   3                              rgb(200,0,0);
 155   3                      }
 156   2      
 157   2      
 158   2              }
 159   1      }
 160          
 161          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    507    ----
   CONSTANT SIZE    =     23    ----
   XDATA SIZE       =   ----       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     75    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
C51 COMPILER V9.53.0.0   MAIN                                                              03/29/2016 00:06:39 PAGE 4   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
